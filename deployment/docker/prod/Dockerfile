FROM jioaicr.azurecr.io/jioai-sports-micip/python:3.9
ARG app_location='/usr/app'
ARG BUILD_ENV

EXPOSE 5003
RUN mkdir -p /usr/app/data/output
RUN mkdir -p /usr/app/logs

WORKDIR ${app_location}
COPY requirements.txt "${app_location}/"

ENV http_proxy "http://lwproxy.jio.com:8080/"
ENV https_proxy "http://lwproxy.jio.com:8080/"
ENV no_proxy "devopsartifact.jio.com"

RUN pip install -r requirements.txt

RUN apt-get update && apt-get -y install cron
COPY . /usr/app/

ENV http_proxy ""
ENV https_proxy ""


ARG DB_HOST
ARG DB_PORT
ARG DB_NAME
ARG DB_PASSWORD
ARG DB_USER
ARG SFTP_SM_HOST
ARG SFTP_SM_USERNAME
ARG SFTP_SM_PASSWORD
ARG SFTP_SM_PORT
ARG IMAGE_STORE_URL
ARG BASE_URL
ARG TOKEN
ARG EMIRATES_BASE_URL
ARG EMIRATES_TOKEN
ARG APP_HOST
ARG APP_PORT
ARG AUTH_SECRET_KEY_1
ARG AUTH_SECRET_KEY_2
ARG USER_QUERY_DIR_NAME
ARG STORAGE_ACCOUNT_NAME
ARG STORAGE_ACCOUNT_KEY
ARG CONTAINER_NAME
ARG CNS_ENDPOINT
ARG CNS_URL
ARG KNIGHT_WATCH_ENDPOINT
ARG KNIGHT_WATCH_TENANT_AUTH
ARG KNIGHT_WATCH_URL
ARG WELLNESS_CAMPAIGN_BUSINESS
ARG GPS_CAMPAIGN_BUSINESS
ARG CAMPAIGN_ENCRYPTION_SECRET_KEY
ARG CAMPAIGN_AUTH_ID
ARG GPS_CAMPAIGN_TEMPLATE
ARG WELLNESS_CAMPAIGN_TEMPLATE
ARG GPS_CAMPAIGN_CODE
ARG WELLNESS_CAMPAIGN_CODE
ARG WHATSAPP_ENDPOINT
ARG APP_BASE_URL
ARG FIELDING_ANALYSIS_DIR_NAME
ARG UMS_BASE_URL
ARG SMARTABASE_USER
ARG SMARTABASE_PASSWORD
ARG SMARTABASE_APP
ARG SMARTABASE_URL
ARG FILE_SHARE_PATH
ARG INGESTION_ENABLED
ARG SFTP_INGESTION_ENABLED
ARG BUILD_ENV
ARG SMTP_PASSWORD
ARG SMTP_EMAIL
ARG SMTP_SERVER_IP
ARG SMTP_PORT
ARG WPL_TOKEN
ARG ALLOWED_HOSTS

# Copy the cron files
COPY ./cron_schedule /etc/cron.d/cron_schedule

# Give execution rights on the combined cron job
RUN chmod a+x /etc/cron.d/cron_schedule

# Apply the combined cron job
RUN crontab /etc/cron.d/cron_schedule

## Create the log file to be able to run tail
RUN touch /var/log/schedule_gps_cron.log
RUN touch /var/log/smartabase_cron.log
RUN touch /var/log/schedule_cron.log
RUN touch /var/log/calendar_reminder.log

ENV DB_HOST=${DB_HOST}
ENV DB_PORT=${DB_PORT}
ENV DB_NAME=${DB_NAME}
ENV DB_PASSWORD=${DB_PASSWORD}
ENV DB_USER=${DB_USER}
ENV SFTP_SM_HOST=${SFTP_SM_HOST}
ENV SFTP_SM_USERNAME=${SFTP_SM_USERNAME}
ENV SFTP_SM_PASSWORD=${SFTP_SM_PASSWORD}
ENV SFTP_SM_PORT=${SFTP_SM_PORT}
ENV IMAGE_STORE_URL=${IMAGE_STORE_URL}
ENV BASE_URL=${BASE_URL}
ENV TOKEN=${TOKEN}
ENV EMIRATES_BASE_URL=${EMIRATES_BASE_URL}
ENV EMIRATES_TOKEN=${EMIRATES_TOKEN}
ENV APP_HOST=${APP_HOST}
ENV APP_PORT=${APP_PORT}
ENV AUTH_SECRET_KEY_1=${AUTH_SECRET_KEY_1}
ENV AUTH_SECRET_KEY_2=${AUTH_SECRET_KEY_2}
ENV USER_QUERY_DIR_NAME=${USER_QUERY_DIR_NAME}
ENV STORAGE_ACCOUNT_NAME=${STORAGE_ACCOUNT_NAME}
ENV STORAGE_ACCOUNT_KEY=${STORAGE_ACCOUNT_KEY}
ENV CONTAINER_NAME=${CONTAINER_NAME}
ENV CNS_ENDPOINT=${CNS_ENDPOINT}
ENV CNS_URL=${CNS_URL}
ENV KNIGHT_WATCH_ENDPOINT=${KNIGHT_WATCH_ENDPOINT}
ENV KNIGHT_WATCH_TENANT_AUTH=${KNIGHT_WATCH_TENANT_AUTH}
ENV KNIGHT_WATCH_URL=${KNIGHT_WATCH_URL}
ENV WELLNESS_CAMPAIGN_BUSINESS=${WELLNESS_CAMPAIGN_BUSINESS}
ENV GPS_CAMPAIGN_BUSINESS=${GPS_CAMPAIGN_BUSINESS}
ENV CAMPAIGN_ENCRYPTION_SECRET_KEY=${CAMPAIGN_ENCRYPTION_SECRET_KEY}
ENV CAMPAIGN_AUTH_ID=${CAMPAIGN_AUTH_ID}
ENV GPS_CAMPAIGN_TEMPLATE=${GPS_CAMPAIGN_TEMPLATE}
ENV WELLNESS_CAMPAIGN_TEMPLATE=${WELLNESS_CAMPAIGN_TEMPLATE}
ENV GPS_CAMPAIGN_CODE=${GPS_CAMPAIGN_CODE}
ENV WELLNESS_CAMPAIGN_CODE=${WELLNESS_CAMPAIGN_CODE}
ENV WHATSAPP_ENDPOINT=${WHATSAPP_ENDPOINT}
ENV APP_BASE_URL=${APP_BASE_URL}
ENV FIELDING_ANALYSIS_DIR_NAME=${FIELDING_ANALYSIS_DIR_NAME}
ENV UMS_BASE_URL=${UMS_BASE_URL}
ENV SMARTABASE_USER=${SMARTABASE_USER}
ENV SMARTABASE_PASSWORD=${SMARTABASE_PASSWORD}
ENV SMARTABASE_APP=${SMARTABASE_APP}
ENV SMARTABASE_URL=${SMARTABASE_URL}
ENV FILE_SHARE_PATH=${FILE_SHARE_PATH}
ENV INGESTION_ENABLED=${INGESTION_ENABLED}
ENV SFTP_INGESTION_ENABLED=${SFTP_INGESTION_ENABLED}
ENV BUILD_ENV=${BUILD_ENV}
ENV SMTP_PASSWORD=${SMTP_PASSWORD}
ENV SMTP_EMAIL=${SMTP_EMAIL}
ENV SMTP_SERVER_IP=${SMTP_SERVER_IP}
ENV SMTP_PORT=${SMTP_PORT}
ENV WPL_TOKEN=${WPL_TOKEN}
ENV ALLOWED_HOSTS=${ALLOWED_HOSTS}

ENV PYTHONPATH="${app_location}:${PYTHONPATH}"
RUN python generate_env.py
RUN chmod a+x docker_run_script.sh
RUN chmod a+x wellness_run.sh
RUN chmod a+x run.sh
RUN #chmod a+x smartabase_run.sh
RUN chmod a+x calendar_run.sh
CMD ["./docker_run_script.sh"]
